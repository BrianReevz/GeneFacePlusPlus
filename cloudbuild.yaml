steps:
  # Pull base images and build in a single container 123
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Pulling base images..."
        docker pull nvcr.io/nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04
        docker pull nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04
        echo "building base image for pytorch"
        docker buildx build -t ubuntu22.04-cu118-conda:torch2.0.1-py39 -f Dockerfile.cu118.torch2.0.1.py39 .
        echo "Building GeneFace++ image..."
        docker buildx build -t genfaceplus:0219 -f Dockerfile.genface .

  # Step 3: Tag the final image for Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'tag',
      'genfaceplus:latest',
      '$_REGION-docker.pkg.dev/$PROJECT_ID/geneface-repo/genfaceplus:latest'
    ]

  # Step 4: Push the image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'push',
      '$_REGION-docker.pkg.dev/$PROJECT_ID/geneface-repo/genfaceplus:latest'
    ]

# Store images in Artifact Registry
images:
  - '$_REGION-docker.pkg.dev/$PROJECT_ID/geneface-repo/genfaceplus:latest'

# Build timeout (in seconds)
timeout: '1800s'

# Machine type for faster builds (optional)
options:
  machineType: 'E2_HIGHCPU_8'

# Substitutions for region
substitutions:
  _REGION: 'us-central1' 